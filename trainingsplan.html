<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainingsplan — SG Rugbyunion Hohen Neuendorf</title>
    <link rel="stylesheet" href="common.css">
    <script src="common.js"></script>
    <style>
        /* Container override */
        .container { max-width: 900px; }

        /* Session List */
        .session-list { display: flex; flex-direction: column; gap: 1rem; }

        .session-card {
            background: var(--bg-card); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px; overflow: hidden; transition: all 0.2s;
        }
        .session-card:hover { border-color: rgba(255,255,255,0.12); }

        .session-header {
            padding: 1rem 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between; gap: 0.8rem;
        }
        .session-header:hover { background: var(--bg-card-hover); }
        .session-date {
            font-size: 1.1rem; font-weight: 800;
            background: linear-gradient(135deg, var(--accent), var(--accent-blue));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .session-meta { font-size: 0.8rem; color: var(--text-muted); }
        .session-meta strong { color: var(--text); }
        .session-duration-chip {
            background: rgba(46,204,113,0.12); color: var(--accent);
            padding: 0.2rem 0.6rem; border-radius: 12px;
            font-size: 0.75rem; font-weight: 700; white-space: nowrap;
        }
        .session-chevron { color: var(--text-muted); font-size: 1.2rem; transition: transform 0.2s; }
        .session-card.open .session-chevron { transform: rotate(90deg); }

        .session-body { display: none; padding: 0 1.2rem 1rem; }
        .session-card.open .session-body { display: block; }

        /* Timeline */
        .timeline { display: flex; flex-direction: column; gap: 0; margin-top: 0.5rem; }
        .timeline-block {
            display: flex; align-items: stretch; gap: 0; border-radius: 8px;
            overflow: hidden; margin-bottom: 2px; position: relative;
        }
        .block-color {
            width: 5px; min-height: 100%; flex-shrink: 0;
        }
        .block-content {
            flex: 1; padding: 0.6rem 0.8rem;
            background: rgba(255,255,255,0.03);
        }
        .block-top { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
        .block-name { font-weight: 700; font-size: 0.85rem; }
        .block-type {
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.04em; padding: 0.1rem 0.5rem; border-radius: 10px;
        }
        .block-dur { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }
        .block-desc { font-size: 0.78rem; color: var(--text-muted); margin-top: 0.3rem; }
        .block-links { font-size: 0.72rem; margin-top: 0.3rem; }
        .block-links a { color: var(--accent-blue); text-decoration: none; }
        .block-links a:hover { text-decoration: underline; }
        .block-actions { display: none; gap: 0.2rem; margin-left: auto; }
        .trainer-active .block-actions { display: flex; }
        .block-actions button {
            background: transparent; border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted); font-size: 0.65rem; padding: 0.15rem 0.35rem;
            border-radius: 4px; cursor: pointer;
        }
        .block-actions button:hover { color: var(--text); border-color: rgba(255,255,255,0.25); }

        /* Block type colors */
        .type-warmup { background: rgba(232,160,32,0.15); color: var(--warning); }
        .color-warmup { background: var(--warning); }
        .type-technik { background: rgba(74,158,255,0.15); color: var(--accent-blue); }
        .color-technik { background: var(--accent-blue); }
        .type-kontakt { background: rgba(224,64,64,0.15); color: var(--danger); }
        .color-kontakt { background: var(--danger); }
        .type-spielform { background: rgba(46,204,113,0.15); color: var(--accent); }
        .color-spielform { background: var(--accent); }
        .type-fitness { background: rgba(168,85,247,0.15); color: #a855f7; }
        .color-fitness { background: #a855f7; }
        .type-cooldown { background: rgba(120,150,180,0.15); color: #7896b4; }
        .color-cooldown { background: #7896b4; }
        .type-besprechung { background: rgba(255,255,255,0.08); color: var(--text-muted); }
        .color-besprechung { background: var(--text-muted); }

        /* Visual Timeline Bar */
        .timeline-bar {
            display: flex; height: 12px; border-radius: 6px; overflow: hidden;
            margin-bottom: 0.8rem; background: rgba(255,255,255,0.04);
        }
        .timeline-bar-seg { height: 100%; transition: width 0.3s; position: relative; }
        .timeline-bar-seg:hover { opacity: 0.8; }

        /* Session actions */
        .session-actions { display: none; gap: 0.3rem; }
        .trainer-active .session-actions { display: flex; }
        .session-actions button {
            padding: 0.25rem 0.6rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);
            background: transparent; color: var(--text-muted); font-size: 0.75rem;
            font-weight: 600; cursor: pointer;
        }
        .session-actions button:hover { color: var(--text); border-color: rgba(255,255,255,0.25); }
        .session-actions .btn-del:hover { color: var(--danger); border-color: var(--danger); }

        /* FAB */
        .fab {
            position: fixed; bottom: 1.5rem; right: 1.5rem;
            width: 56px; height: 56px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, var(--green), var(--blue));
            color: white; font-size: 1.8rem; cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 50;
            display: none; align-items: center; justify-content: center;
        }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.85); align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .form-modal {
            background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; width: min(95vw, 550px); max-height: 90vh;
            overflow-y: auto; padding: 1.5rem;
        }
        .form-modal h2 { font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; }
        .form-group { margin-bottom: 0.8rem; }
        .form-group label {
            display: block; font-size: 0.8rem; font-weight: 600;
            color: var(--text-muted); margin-bottom: 0.3rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.6rem 0.8rem; border: 1px solid rgba(255,255,255,0.12);
            border-radius: 8px; background: var(--primary); color: var(--text);
            font-size: 0.9rem; font-family: inherit; outline: none;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); }
        .form-group textarea { resize: vertical; min-height: 50px; }
        .form-group select { -webkit-appearance: none; -moz-appearance: none; appearance: none; cursor: pointer; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .form-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-primary { background: linear-gradient(135deg, var(--green), var(--blue)); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-cancel { background: transparent; border: 1px solid rgba(255,255,255,0.15); color: var(--text-muted); }
        .btn-cancel:hover { color: var(--text); border-color: rgba(255,255,255,0.3); }

        /* Empty */
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
        .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

        /* Print */
        @media print {
            body { background: white; color: black; }
            .topnav, .trainer-bar, .login-gate, #trainer-gate, .fab, .block-actions, .session-actions,
            .save-indicator, .session-chevron { display: none !important; }
            .app-content { display: block !important; }
            .session-body { display: block !important; }
            .session-card { border: 1px solid #ccc; page-break-inside: avoid; }
            .block-content { background: #f5f5f5; }
            .page-header { background: none; border-bottom: 2px solid #333; }
            .page-header h1, .session-date { color: black; -webkit-text-fill-color: black; }
            .timeline-bar-seg { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
        }

        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
</head>
<body>

    <!-- LOGIN GATE -->
    <div class="login-gate" id="login-gate">
        <div class="login-box">
            <h2>Team Hub</h2>
            <div class="login-clubs">
                <span class="club-green">RU Hohen Neuendorf</span>
                <span class="club-x">&times;</span>
                <span class="club-blue">Stahl Hennigsdorf</span>
            </div>
            <input type="password" class="login-input" id="login-pw" placeholder="Passwort eingeben" autocomplete="off">
            <button class="login-btn" id="login-btn">Anmelden</button>
            <div class="login-error" id="login-error">Falsches Passwort</div>
        </div>
    </div>

    <!-- TRAINER-ONLY GATE (after team login) -->
    <div class="login-gate" id="trainer-gate" style="display:none">
        <div class="login-box">
            <h2>Trainingsplan</h2>
            <div class="login-clubs" style="margin-bottom:0.8rem">Nur für Trainer zugänglich</div>
            <input type="password" class="login-input" id="trainer-pin-input" placeholder="Trainer-PIN eingeben" autocomplete="off" inputmode="numeric">
            <button class="login-btn" id="trainer-pin-btn">Freischalten</button>
            <div class="login-error" id="trainer-pin-error">Falscher PIN</div>
            <div style="margin-top:1rem">
                <a href="index.html" style="color:var(--text-muted);font-size:0.8rem;text-decoration:none">Zurück zum Hub</a>
            </div>
        </div>
    </div>

    <!-- NAV -->
    <nav class="topnav app-content" id="topnav">
        <div class="topnav-inner">
            <a href="index.html">Hub</a>
            <span class="nav-sep">|</span>
            <a href="kader.html">Kader</a>
            <a href="aufstellung.html">Aufstellung</a>
            <a href="mannschaftsrat.html">Mannschaftsrat</a>
            <span class="nav-sep">|</span>
            <a href="spielzuege.html">Spielzüge</a>
            <a href="uebungen.html">Übungen</a>
            <a href="trainingsplan.html" class="active">Training</a>
            <a href="videos.html">Videos</a>
            <span class="nav-sep">|</span>
            <a href="trainingsbeteiligung.html">Beteiligung</a>
        </div>
    </nav>

    <!-- HEADER -->
    <header class="page-header app-content">
        <h1>Trainingsplan</h1>
        <div class="subtitle">Trainingseinheiten planen & strukturieren</div>
    </header>

    <!-- MAIN -->
    <div class="app-content" id="main-content">
        <div class="container">
            <div class="trainer-bar">
                <span class="trainer-info unlocked" id="trainer-info">Trainer-Bereich</span>
                <button class="trainer-btn" style="font-size:0.75rem;padding:0.35rem 0.8rem" onclick="window.print()">Drucken</button>
            </div>
            <div class="save-indicator" id="save-indicator">Gespeichert</div>

            <div class="session-list" id="session-list"></div>
            <div class="empty-state" id="empty-state" style="display:none">
                <div class="icon">&#128203;</div>
                <p>Noch keine Trainingseinheiten vorhanden.</p>
            </div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab" id="fab-add" onclick="openSessionForm()" title="Trainingseinheit erstellen">+</button>

    <!-- Session Form Modal -->
    <div class="modal-overlay" id="session-modal">
        <div class="form-modal">
            <h2 id="session-form-title">Trainingseinheit erstellen</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Datum</label>
                    <input type="date" id="fs-date">
                </div>
                <div class="form-group">
                    <label>Uhrzeit</label>
                    <input type="time" id="fs-time" value="19:00">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Gesamtdauer (Min.)</label>
                    <input type="number" id="fs-duration" value="120" min="15" step="5">
                </div>
                <div class="form-group">
                    <label>Ort</label>
                    <input type="text" id="fs-location" value="Hohen Neuendorf">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-cancel" onclick="closeSessionForm()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveSession()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Block Form Modal -->
    <div class="modal-overlay" id="block-modal">
        <div class="form-modal">
            <h2 id="block-form-title">Block hinzufügen</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="fb-name" placeholder="z.B. Aufwärmen mit Ball">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Typ</label>
                    <select id="fb-type">
                        <option value="warmup">Warm-up</option>
                        <option value="technik">Technik</option>
                        <option value="kontakt">Kontakt</option>
                        <option value="spielform">Spielform</option>
                        <option value="fitness">Fitness</option>
                        <option value="cooldown">Cool-down</option>
                        <option value="besprechung">Besprechung</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Dauer (Min.)</label>
                    <input type="number" id="fb-duration" value="15" min="5" step="5">
                </div>
            </div>
            <div class="form-group">
                <label>Beschreibung (optional)</label>
                <textarea id="fb-desc" placeholder="Ablauf, Übungen..."></textarea>
            </div>
            <div class="form-group">
                <label>Spielzug verknüpfen (optional)</label>
                <select id="fb-play"><option value="">— Kein Spielzug —</option></select>
            </div>
            <div class="form-group">
                <label>Video verknüpfen (optional)</label>
                <select id="fb-video"><option value="">— Kein Video —</option></select>
            </div>
            <div class="form-actions">
                <button class="btn btn-cancel" onclick="closeBlockForm()">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveBlock()">Speichern</button>
            </div>
        </div>
    </div>

<script>
    const db = initFirebase();

    let sessions = {};
    let refPlays = {};
    let refVideos = {};
    let trainerMode = false;
    let editingSessionId = null;
    let editingBlockIdx = null;
    let currentSessionId = null;

    const typeLabels = {
        warmup: 'Warm-up', technik: 'Technik', kontakt: 'Kontakt',
        spielform: 'Spielform', fitness: 'Fitness', cooldown: 'Cool-down', besprechung: 'Besprechung'
    };

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    function formatDate(dateStr) {
        const d = new Date(dateStr + 'T00:00:00');
        const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        return `${days[d.getDay()]}, ${d.getDate()}.${(d.getMonth()+1).toString().padStart(2,'0')}.${d.getFullYear()}`;
    }

    // --- RENDER ---
    function render() {
        const list = document.getElementById('session-list');
        const empty = document.getElementById('empty-state');
        const entries = Object.entries(sessions).sort((a, b) => {
            // Sort by date descending (newest first)
            return (b[1].date || '').localeCompare(a[1].date || '');
        });

        if (entries.length === 0) {
            list.innerHTML = '';
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';

        list.innerHTML = entries.map(([id, s]) => {
            const blocks = Array.isArray(s.blocks) ? s.blocks : Object.values(s.blocks || {});
            const totalBlockMin = blocks.reduce((sum, b) => sum + (parseInt(b.duration) || 0), 0);

            // Timeline bar segments
            const barHtml = blocks.map(b => {
                const pct = s.duration > 0 ? ((parseInt(b.duration) || 0) / s.duration * 100) : 0;
                return `<div class="timeline-bar-seg color-${b.type}" style="width:${pct}%" title="${esc(b.name)} (${b.duration} min)"></div>`;
            }).join('');

            // Block list
            const blocksHtml = blocks.map((b, idx) => `
                <div class="timeline-block">
                    <div class="block-color color-${b.type}"></div>
                    <div class="block-content">
                        <div class="block-top">
                            <div>
                                <span class="block-name">${esc(b.name)}</span>
                                <span class="block-type type-${b.type}">${typeLabels[b.type] || b.type}</span>
                            </div>
                            <span class="block-dur">${b.duration} min</span>
                            <div class="block-actions">
                                <button onclick="moveBlock('${id}',${idx},-1)" title="Hoch">&#9650;</button>
                                <button onclick="moveBlock('${id}',${idx},1)" title="Runter">&#9660;</button>
                                <button onclick="editBlock('${id}',${idx})">&#9998;</button>
                                <button onclick="deleteBlock('${id}',${idx})" style="color:var(--danger)">&#10005;</button>
                            </div>
                        </div>
                        ${b.description ? `<div class="block-desc">${esc(b.description)}</div>` : ''}
                        ${b.playRef || b.videoRef ? `<div class="block-links">${
                            b.playRef && refPlays[b.playRef] ? `<a href="spielzuege.html">&#127944; ${esc(refPlays[b.playRef].name)}</a>` : ''
                        }${b.playRef && b.videoRef ? ' &middot; ' : ''}${
                            b.videoRef && refVideos[b.videoRef] ? `<a href="videos.html">&#127909; ${esc(refVideos[b.videoRef].title)}</a>` : ''
                        }</div>` : ''}
                    </div>
                </div>
            `).join('');

            return `
                <div class="session-card" id="session-${id}">
                    <div class="session-header" onclick="toggleSession('${id}')">
                        <div>
                            <div class="session-date">${formatDate(s.date)}</div>
                            <div class="session-meta">
                                <strong>${s.startTime || '19:00'}</strong> Uhr · ${esc(s.location || 'Hohen Neuendorf')}
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.5rem">
                            <span class="session-duration-chip">${s.duration} min</span>
                            <span class="session-chevron">&#9654;</span>
                        </div>
                    </div>
                    <div class="session-body">
                        <div class="timeline-bar">${barHtml}</div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                            <span style="font-size:0.75rem;color:var(--text-muted)">${blocks.length} Blöcke · ${totalBlockMin}/${s.duration} min geplant</span>
                            <div class="session-actions">
                                <button onclick="addBlock('${id}')">+ Block</button>
                                <button onclick="editSession('${id}')">Bearbeiten</button>
                                <button class="btn-del" onclick="deleteSession('${id}')">Löschen</button>
                            </div>
                        </div>
                        <div class="timeline">${blocksHtml}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleSession(id) {
        document.getElementById('session-' + id).classList.toggle('open');
    }

    // --- SESSION CRUD ---
    function openSessionForm(id) {
        editingSessionId = id || null;
        if (id && sessions[id]) {
            const s = sessions[id];
            document.getElementById('fs-date').value = s.date || '';
            document.getElementById('fs-time').value = s.startTime || '19:00';
            document.getElementById('fs-duration').value = s.duration || 120;
            document.getElementById('fs-location').value = s.location || 'Hohen Neuendorf';
            document.getElementById('session-form-title').textContent = 'Einheit bearbeiten';
        } else {
            document.getElementById('fs-date').value = new Date().toISOString().slice(0,10);
            document.getElementById('fs-time').value = '19:00';
            document.getElementById('fs-duration').value = 120;
            document.getElementById('fs-location').value = 'Hohen Neuendorf';
            document.getElementById('session-form-title').textContent = 'Trainingseinheit erstellen';
        }
        document.getElementById('session-modal').classList.add('open');
    }

    function closeSessionForm() {
        document.getElementById('session-modal').classList.remove('open');
        editingSessionId = null;
    }

    function saveSession() {
        const date = document.getElementById('fs-date').value;
        const startTime = document.getElementById('fs-time').value;
        const duration = parseInt(document.getElementById('fs-duration').value) || 120;
        const location = document.getElementById('fs-location').value.trim() || 'Hohen Neuendorf';
        if (!date) { alert('Datum ist erforderlich.'); return; }

        if (editingSessionId) {
            sessions[editingSessionId] = { ...sessions[editingSessionId], date, startTime, duration, location };
            db.ref('trainingsplaene/' + editingSessionId).update({ date, startTime, duration, location });
        } else {
            const data = { date, startTime, duration, location, blocks: [] };
            const ref = db.ref('trainingsplaene').push();
            ref.set(data);
            sessions[ref.key] = data;
        }
        persist();
        closeSessionForm();
        render();
        showSaved();
    }

    function editSession(id) { openSessionForm(id); }

    function deleteSession(id) {
        if (!confirm('Trainingseinheit wirklich löschen?')) return;
        db.ref('trainingsplaene/' + id).remove();
        delete sessions[id];
        persist();
        render();
        showSaved('Gelöscht');
    }

    // --- BLOCK CRUD ---
    function populateRefDropdowns(playId, videoId) {
        const playSel = document.getElementById('fb-play');
        const vidSel = document.getElementById('fb-video');
        playSel.innerHTML = '<option value="">— Kein Spielzug —</option>';
        vidSel.innerHTML = '<option value="">— Kein Video —</option>';
        for (const [id, p] of Object.entries(refPlays)) {
            playSel.innerHTML += `<option value="${id}" ${id === playId ? 'selected' : ''}>${esc(p.name)}</option>`;
        }
        for (const [id, v] of Object.entries(refVideos)) {
            vidSel.innerHTML += `<option value="${id}" ${id === videoId ? 'selected' : ''}>${esc(v.title)}</option>`;
        }
    }

    function addBlock(sessionId) {
        currentSessionId = sessionId;
        editingBlockIdx = null;
        document.getElementById('fb-name').value = '';
        document.getElementById('fb-type').value = 'warmup';
        document.getElementById('fb-duration').value = 15;
        document.getElementById('fb-desc').value = '';
        populateRefDropdowns('', '');
        document.getElementById('block-form-title').textContent = 'Block hinzufügen';
        document.getElementById('block-modal').classList.add('open');
    }

    function editBlock(sessionId, idx) {
        currentSessionId = sessionId;
        editingBlockIdx = idx;
        const blocks = getBlocks(sessionId);
        const b = blocks[idx];
        document.getElementById('fb-name').value = b.name || '';
        document.getElementById('fb-type').value = b.type || 'warmup';
        document.getElementById('fb-duration').value = b.duration || 15;
        document.getElementById('fb-desc').value = b.description || '';
        populateRefDropdowns(b.playRef || '', b.videoRef || '');
        document.getElementById('block-form-title').textContent = 'Block bearbeiten';
        document.getElementById('block-modal').classList.add('open');
    }

    function closeBlockForm() {
        document.getElementById('block-modal').classList.remove('open');
        currentSessionId = null;
        editingBlockIdx = null;
    }

    function getBlocks(sessionId) {
        const s = sessions[sessionId];
        if (!s) return [];
        return Array.isArray(s.blocks) ? s.blocks : Object.values(s.blocks || {});
    }

    function saveBlock() {
        const name = document.getElementById('fb-name').value.trim();
        const type = document.getElementById('fb-type').value;
        const duration = parseInt(document.getElementById('fb-duration').value) || 15;
        const description = document.getElementById('fb-desc').value.trim();
        const playRef = document.getElementById('fb-play').value || '';
        const videoRef = document.getElementById('fb-video').value || '';
        if (!name) { alert('Name ist erforderlich.'); return; }

        const blocks = getBlocks(currentSessionId);
        const blockData = { name, type, duration, description };
        if (playRef) blockData.playRef = playRef;
        if (videoRef) blockData.videoRef = videoRef;

        if (editingBlockIdx !== null) {
            blocks[editingBlockIdx] = blockData;
        } else {
            blocks.push(blockData);
        }

        sessions[currentSessionId].blocks = blocks;
        db.ref('trainingsplaene/' + currentSessionId + '/blocks').set(blocks);
        persist();
        closeBlockForm();
        render();
        // Keep session open
        const el = document.getElementById('session-' + currentSessionId);
        if (el) el.classList.add('open');
        showSaved();
    }

    function deleteBlock(sessionId, idx) {
        if (!confirm('Block löschen?')) return;
        const blocks = getBlocks(sessionId);
        blocks.splice(idx, 1);
        sessions[sessionId].blocks = blocks;
        db.ref('trainingsplaene/' + sessionId + '/blocks').set(blocks);
        persist();
        render();
        document.getElementById('session-' + sessionId)?.classList.add('open');
        showSaved('Gelöscht');
    }

    function moveBlock(sessionId, idx, dir) {
        const blocks = getBlocks(sessionId);
        const newIdx = idx + dir;
        if (newIdx < 0 || newIdx >= blocks.length) return;
        [blocks[idx], blocks[newIdx]] = [blocks[newIdx], blocks[idx]];
        sessions[sessionId].blocks = blocks;
        db.ref('trainingsplaene/' + sessionId + '/blocks').set(blocks);
        persist();
        render();
        document.getElementById('session-' + sessionId)?.classList.add('open');
    }

    function persist() {
        localStorage.setItem('sgrhn_trainingsplaene', JSON.stringify(sessions));
    }

    // --- LOAD ---
    function loadData() {
        try {
            const stored = localStorage.getItem('sgrhn_trainingsplaene');
            if (stored) sessions = JSON.parse(stored);
        } catch(e) {}
        render();

        db.ref('trainingsplaene').on('value', snap => {
            const data = snap.val();
            if (data) {
                sessions = {};
                for (const [key, val] of Object.entries(data)) {
                    sessions[key] = val;
                    if (val.blocks && !Array.isArray(val.blocks)) {
                        sessions[key].blocks = Object.values(val.blocks);
                    }
                }
            } else {
                sessions = {};
            }
            persist();
            render();
        });

        // Load Spielzüge & Videos for cross-references
        db.ref('spielzuege').on('value', snap => {
            refPlays = snap.val() || {};
            render();
        });
        db.ref('videos').on('value', snap => {
            refVideos = snap.val() || {};
            render();
        });
    }

    // --- TRAINER ---
    function enableTrainer() {
        trainerMode = true;
        document.getElementById('main-content').classList.add('trainer-active');
        document.getElementById('fab-add').style.display = 'flex';
        render();
    }

    // Step 2: Trainer PIN -> show actual content
    function showContent() {
        document.getElementById('trainer-gate').style.display = 'none';
        document.querySelectorAll('.app-content').forEach(el => el.classList.add('visible'));
        enableTrainer();
        loadData();
    }

    async function checkTrainerGate() {
        const stored = localStorage.getItem('sgrhn_trainer_auth');
        if (stored === HASH_PIN) {
            showContent();
        } else {
            document.getElementById('trainer-gate').style.display = 'flex';
        }
    }

    async function tryTrainerPin() {
        const pin = document.getElementById('trainer-pin-input').value;
        const hash = await hashPw(pin);
        if (hash === HASH_PIN) {
            localStorage.setItem('sgrhn_trainer_auth', hash);
            showContent();
        } else {
            document.getElementById('trainer-pin-error').style.display = 'block';
            document.getElementById('trainer-pin-input').value = '';
        }
    }

    document.getElementById('trainer-pin-btn').addEventListener('click', tryTrainerPin);
    document.getElementById('trainer-pin-input').addEventListener('keydown', e => { if (e.key === 'Enter') tryTrainerPin(); });

    // --- LOGIN (Step 1: Team login -> show trainer gate) ---
    setupLogin({ onUnlock() {
        document.getElementById('login-gate').classList.add('hidden');
        firebase.auth().signInAnonymously().catch(err => {
            console.warn('Firebase Auth failed', err);
        });
        checkTrainerGate();
    }});

    // Close modals
    document.getElementById('session-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeSessionForm(); });
    document.getElementById('block-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeBlockForm(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeSessionForm(); closeBlockForm(); } });

</script>

<footer style="text-align:center; padding:2rem 1rem; color:var(--text-muted); font-size:0.85rem;" class="app-content">
    <a href="index.html" style="color:var(--text-muted);">&larr; Team Hub</a> &middot;
    <a href="impressum.html" style="color:var(--text-muted);">Impressum</a> &middot;
    <a href="datenschutz.html" style="color:var(--text-muted);">Datenschutz</a>
</footer>
</body>
</html>
